services:
  chirpstack:
    image: chirpstack/chirpstack:4
    command: -c /etc/chirpstack
    restart: unless-stopped
    volumes:
      - ./configuration/chirpstack:/etc/chirpstack
    depends_on:
      - postgres
      - mosquitto
      - redis
    environment:
      - MQTT_BROKER_HOST=mosquitto
      - REDIS_HOST=redis
      - POSTGRESQL_HOST=postgres
    ports:
      - "${CHIRPSTACK_UI_PORT:-8080}:8080"

  chirpstack-gateway-bridge:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    ports:
      - "1700:1700/udp"
    volumes:
      - ./configuration/chirpstack-gateway-bridge:/etc/chirpstack-gateway-bridge
    environment:
      - INTEGRATION__MQTT__EVENT_TOPIC_TEMPLATE=au915_1/gateway/{{ .GatewayID }}/event/{{ .EventType }}
      - INTEGRATION__MQTT__STATE_TOPIC_TEMPLATE=au915_1/gateway/{{ .GatewayID }}/state/{{ .StateType }}
      - INTEGRATION__MQTT__COMMAND_TOPIC_TEMPLATE=au915_1/gateway/{{ .GatewayID }}/command/#
    depends_on:
      - mosquitto
  
  chirpstack-gateway-bridge-basicstation:
    image: chirpstack/chirpstack-gateway-bridge:4
    restart: unless-stopped
    command: -c /etc/chirpstack-gateway-bridge/chirpstack-gateway-bridge-basicstation-au915_full.toml
    ports:
      - "3001:3001"
    volumes:
      - ./configuration/chirpstack-gateway-bridge:/etc/chirpstack-gateway-bridge
    depends_on:
      - mosquitto

  chirpstack-rest-api:
    image: chirpstack/chirpstack-rest-api:4
    restart: unless-stopped
    command: --server chirpstack:8080 --bind 0.0.0.0:8090 --insecure
    ports:
      - "${CHIRPSTACK_REST_PORT:-8090}:8090"
    depends_on:
      - chirpstack

  postgres:
    image: postgres:14-alpine
    restart: unless-stopped
    volumes:
      - ./configuration/postgresql/initdb:/docker-entrypoint-initdb.d
      - postgresqldata:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=chirpstack
      - POSTGRES_PASSWORD=chirpstack
      - POSTGRES_DB=chirpstack

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: redis-server --save 300 1 --save 60 100 --appendonly no
    volumes:
      - redisdata:/data

  mosquitto:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - "${MOSQUITTO_PORT:-1883}:1883"
    volumes:
      - ./configuration/mosquitto/config/:/mosquitto/config/

  # Bridge MQTT: reenv√≠a downlinks de ChirpStack (Mosquitto) al broker del proveedor.
  # Los downlinks que se programen en ChirpStack se republican en /Milesight/Downlink/<EUI>.
  mqtt-bridge-provider:
    image: python:3.11-alpine
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./scripts/bridge-downlink-chirpstack-to-provider.py:/app/bridge.py
    command: sh -c "pip install --no-cache-dir paho-mqtt && exec python bridge.py"
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      - CHIRPSTACK_MQTT_HOST=mosquitto
      - CHIRPSTACK_MQTT_PORT=1883
      - PROVIDER_MQTT_HOST=lora.honggps.com
      - PROVIDER_MQTT_PORT=8884
      - PROVIDER_MQTT_TLS=true
      - PROVIDER_MQTT_WEBSOCKETS=false
      - PROVIDER_MQTT_CLIENT_ID=mqttx_b3d78c78
      - PROVIDER_DOWNLINK_TOPIC=/Milesight/Downlink/{}
      - PROVIDER_CONNECT_RETRY_SEC=30
      - PROVIDER_OPTIONAL=true
      # Probar en orden: 8884, 8883, 1883, 8084, 8083, 8080, 443 (TLS/WSS/ws). Si uno conecta se usa.
      - PROVIDER_TRY_ALL_PORTS=true
    depends_on:
      - mosquitto

volumes:
  postgresqldata:
  redisdata:
